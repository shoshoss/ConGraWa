<% content_for(:title, t('.title')) %>
<div class="flex justify-center min-h-screen p-5">
  <div class="max-w-xl w-full bg-white rounded-lg shadow-lg">
    <h1 class="text-4xl font-bold mt-4 mb-4 sm:mb-8 text-center">
      <%= t('.title') %>
    </h1>
    <%= form_with model: @user, url: profile_path, method: :patch do |f| %>
      <%= render 'shared/error_messages', object: f.object %>

      <div class="card-body mx-auto">
        <div class="form-control">
          <%= f.label :avatar, 'プロフィール画像', class: 'block text-lg font-semibold mb-2' %>
          <%= f.file_field :avatar, id: "input-avatar", accept: "image/jpeg,image/gif,image/png", class: "input-style", onchange: "previewFile(this)" %>
          <div id="file-name" class="text-gray-600 text-xs mt-1">ファイルが選択されていません</div>
          <img id="preview-avatar" src="<%= @user.avatar.attached? ? url_for(@user.avatar) : 'sample.jpg' %>" class="mt-4 rounded-full mx-auto my-2 border w-32 h-32">
        </div>




        <div class="form-control">
          <%= f.label :display_name, '名前', class: "label-text text-lg font-semibold mb-1" %>
          <%= f.text_field :display_name, class: "input-style" %>
        </div>

        <div class="form-control mt-2">
          <%= f.label :username_slug, 'ユーザー名', class: "label-text text-lg font-semibold mb-1" %>
          <%= f.text_field :username_slug, class: "input-style" %>
        </div>

        <div class="form-control mt-2">
          <%= f.label :self_introduction, '自己紹介', class: "label-text text-lg font-semibold mb-1" %>
          <%= f.text_area :self_introduction, class: "input-style", rows: "8", style: "resize: vertical;" %>
        </div>
        
        <div class="form-control mt-4 lg:mt-6">
          <%= f.submit "プロファイル更新", class: "btn btn-primary text-lg w-full" %>
        </div>
      </div>
    <% end %>

  </div>

</div>

<script>
  // プレビュー機能
document.addEventListener("DOMContentLoaded", function() {
  const preview = document.getElementById('preview-avatar');
  // 現在の画像のURLを保存
  const currentAvatarSrc = preview.src;

  document.getElementById('input-avatar').addEventListener('change', function() {
    var file = this.files[0];

    if (!file) {
      // ファイル選択がキャンセルされた場合、元の画像を表示
      preview.src = currentAvatarSrc;
      return;
    }

    if (file.size > 5 * 1024 * 1024) {
      alert("ファイルサイズは5MB以下にしてください。");
      // サイズオーバーの場合も元の画像を表示
      preview.src = currentAvatarSrc;
      return;
    }

    var reader = new FileReader();
    reader.onload = function(e) {
      // ファイル読み込み成功時にプレビューを更新
      preview.src = e.target.result;
    };
    reader.onerror = function() {
      alert("ファイルの読み込みに失敗しました。");
      // 読み込み失敗時にも元の画像を表示
      preview.src = currentAvatarSrc;
    };
    reader.readAsDataURL(file);
  });
});


  // 自動リサイズのテキストエリア
  window.onload = function() {
  const textarea = document.getElementById('self_introduction');
  if (textarea) {
    adjustTextareaHeight(textarea);
  }
};

function adjustTextareaHeight(textarea) {
  textarea.style.height = 'auto'; // Reset height to ensure proper adjustment
  textarea.style.height = textarea.scrollHeight + 'px'; // Set new height based on content
}


</script>