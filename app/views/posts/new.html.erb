<%= turbo_frame_tag "post_modal" do %>
  <dialog id="post_modal_dialog" class="modal bg-gray-500 bg-opacity-50"  data-controller="post-modal">
    <div class="modal-box p-2">
      <div class="flex justify-end items-center">
        <button class="text-blue-500 hover:text-blue-700 font-semibold" data-action="click->post-modal#closeModal">閉じる</button>
      </div>

        <div class="mx-auto pt-2">
          <!-- 録音コントロール -->
          <section>
            <canvas class="visualizer w-full h-24 md:h-80" style="background-color: #05aaff;"></canvas>
          </section>

          <div class="flex justify-around items-center pt-2 px-5">
            <button class="record text-xl bg-blue-500 hover:bg-blue-700 text-white font-semibold py-2 px-5 md:px-10 rounded disabled:opacity-50" data-action="click->post-modal#startRecording">
              録音<br class="md:hidden">開始
            </button>
            <span class="timer text-gray-800 font-semibold text-3xl md:text-3xl lg:text-3xl">00:00</span>
            <button class="stop text-xl bg-red-500 hover:bg-red-700 text-white font-semibold py-2 px-5 md:px-10 rounded disabled:opacity-50" data-action="click->post-modal#stopRecording" disabled>
              録音<br class="md:hidden">完了
            </button>
          </div>
          <%= form_with model: @post,
                        data: { controller: "post-modal", 
                        action: "turbo:submit-end->post-modal#afterClose" } do |f| %>
            <%= render 'shared/error_messages', object: f.object %>
            <div class="card-body p-2">
                <div class="form-control pt-2">
                  <%= f.label :body, '投稿内容', class: "block text-lg font-semibold", for: "body" %>
                  <%= f.text_area :body, id: 'body', class: "block mt-1 p-2 text-sm sm:text-lg border-2 border-gray-300 rounded-lg focus:outline-none focus:ring focus:border-sky-500 resize-y", rows: "3", style: "resize: vertical;" %>
                </div>

              <section class="sound-clips">
                <!-- 音声クリップはここに表示 -->
              </section>

              <%= f.file_field :audio, direct_upload: true, class: "hidden" %>
              <%= f.hidden_field :duration, class: "duration-field" %>

              <!-- プライバシー設定 -->
              <div class="form-control pt-2">
                <%= f.label :privacy, 'プライバシー設定', class: "block text-lg font-semibold" %>
                <div class="flex space-x-4">
                  <label class="inline-flex items-center">
                    <%= f.radio_button :privacy, :only_me, checked: true, class: "form-radio" %>
                    <span class="ml-2">自分のみ</span>
                  </label>
                  <label class="inline-flex items-center">
                    <%= f.radio_button :privacy, :friends_only, class: "form-radio" %>
                    <span class="ml-2">友達のみ</span>
                  </label>
                  <label class="inline-flex items-center">
                    <%= f.radio_button :privacy, :open, class: "form-radio" %>
                    <span class="ml-2">公開</span>
                  </label>
                </div>
              </div>

              <div class="form-control mt-4 lg:mt-6">
                <%= f.submit t('helpers.submit.post'), class: "btn text-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded disabled:opacity-50" %>
              </div>
            </div>
          <% end %>
        </div>

      <!-- モーダルを閉じるボタン -->
      <div class="modal-action my-4 flex justify-center">
        <button class="btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded" data-action="click->post-modal#closeModal">閉じる</button>
      </div>
    </div>
  </dialog>

<script>
  document.addEventListener('input', function (event) {
    if (event.target.tagName.toLowerCase() !== 'textarea') return;
    event.target.style.height = 'auto';
    event.target.style.height = (event.target.scrollHeight) + 'px';
  });
</script>
<% end %>
